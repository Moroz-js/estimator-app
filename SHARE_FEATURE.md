# Система приглашений в проекты

## Что добавлено

1. **Кнопка "Пригласить"** в EstimatorApp (шаг 3 - эпики)
   - Появляется только для сохранённых проектов
   - Открывает prompt для ввода email пользователя
   - Добавляет пользователя в проект с ролью "viewer"
   - Только владелец проекта может приглашать

2. **Раздел "Гостевые проекты"** на главной странице
   - Показывает проекты, в которые пользователь был приглашён
   - Отображает email пригласившего пользователя
   - Визуально отличается от "Моих проектов" (синий фон)
   - Автоматически загружается при входе

3. **API endpoint `/api/invite`**
   - Принимает projectId, email и accessToken
   - Проверяет, что приглашающий - владелец проекта
   - Ищет пользователя по email в базе
   - Добавляет запись в project_members с invited_by
   - Возвращает ошибку, если пользователь не найден или уже добавлен

4. **Обновлённая таблица project_members**
   - Добавлено поле `invited_by` (UUID, ссылка на auth.users)
   - Хранит ID пользователя, который пригласил
   - NULL для владельца проекта
   - Используется для отображения информации о приглашении

## Схема базы данных

Файл **`supabase_migrations_all.sql`** содержит полную схему базы данных:

- **Таблицы**: `projects`, `project_members`
- **Индексы**: для оптимизации запросов
- **RPC функции**: `find_user_id_by_email` для поиска пользователей
- **Комментарии**: документация к таблицам и колонкам
- **Политики безопасности**: примеры RLS (закомментированы)

Этот файл можно использовать для:
- Создания схемы с нуля в новом проекте
- Проверки текущей схемы
- Добавления недостающих элементов (функций, индексов)

Выполните в Supabase SQL Editor. Команды `CREATE IF NOT EXISTS` безопасны для повторного выполнения.

## Как использовать

### Пригласить пользователя:
1. Откройте свой проект (вы должны быть владельцем)
2. Перейдите на шаг 3 (Эпики и подзадачи)
3. Нажмите кнопку "Пригласить"
4. Введите email пользователя (он должен быть зарегистрирован)
5. Пользователь увидит проект в разделе "Гостевые проекты"

### Просмотреть гостевые проекты:
1. На главной странице прокрутите вниз
2. Раздел "Гостевые проекты" появится, если вас кто-то пригласил
3. Каждая карточка показывает, кто вас пригласил
4. Нажмите на проект, чтобы открыть его

### Роли пользователей:
- **owner** - владелец проекта, может приглашать других
- **viewer** - приглашённый пользователь, может просматривать проект

## Технические детали

### RPC функция
Для работы с таблицей `auth.users` используется RPC функция с `SECURITY DEFINER`:
- `find_user_id_by_email(user_email TEXT)` - находит ID пользователя по email

Эта функция выполняется с повышенными правами и безопасно обращается к auth.users.

### Оптимизация
Email приглашающего сохраняется в поле `invited_by_email` таблицы `project_members` для быстрого отображения без дополнительных запросов.

## Ограничения

- Пользователь должен быть зарегистрирован в системе
- Приглашать может только владелец проекта
- Нельзя пригласить пользователя дважды
- Email должен точно совпадать с зарегистрированным

## Безопасность

- Проверка прав доступа на уровне API
- Только владелец может приглашать пользователей
- Приглашённые пользователи видят проект в read-only режиме
- Все операции требуют авторизации
